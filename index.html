<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DEMNET • Premium Alzheimer MRI UI</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script src="https://unpkg.com/@lottiefiles/lottiefiles/lottie-player.js"></script>

  <style>
    :root {
      --bg: #0f172a;
      --card: #0b1220;
      --accent: #06b6d4;
      --neon: #7c3aed;
    }

    body {
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 600px at 10% 10%, rgba(124, 58, 237, 0.06), transparent 6%),
        radial-gradient(900px 400px at 90% 90%, rgba(6, 182, 212, 0.04), transparent 6%),
        var(--bg);
      color: #e6eef8;
      min-height: 100vh;
    }

    .glass {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
      border: 1px solid rgba(255, 255, 255, 0.04);
      backdrop-filter: blur(6px);
    }

    .neon {
      box-shadow: 0 6px 30px rgba(124, 58, 237, 0.12), 0 0 8px rgba(6, 182, 212, 0.06);
      border-radius: 12px;
    }

    .magnetic {
      transition: transform 0.22s cubic-bezier(.2, .9, .2, 1);
      will-change: transform;
    }

    .magnetic:active {
      transform: scale(.98);
    }

    #toast {
      position: fixed;
      right: 20px;
      bottom: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .toast-item {
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      padding: 10px 14px;
      border-radius: 10px;
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.5);
    }

    #particles {
      position: fixed;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      z-index: 0;
      pointer-events: none;
      mix-blend-mode: screen;
      filter: blur(8px) saturate(1.2);
    }

    @media(max-width:720px) {
      .desktop-only {
        display: none
      }

      .mobile-block {
        display: block
      }
    }

    /* FIX 1: Max specificity for hiding pages */
    .page.hidden,
    .hidden-el {
      display: none !important;
    }

    .gradcam-overlay {
      mix-blend-mode: color-dodge;
      pointer-events: none;
      position: absolute;
      inset: 0;
      opacity: 0.6;
      filter: blur(8px);
    }

    /* Mobile menu & hamburger (right) */
    #hamburger {
      display: flex;
      flex-direction: column;
      gap: 5px;
      cursor: pointer;
      padding: 8px;
    }

    #hamburger span {
      width: 22px;
      height: 3px;
      background: #fff;
      border-radius: 2px;
      transition: all 0.35s ease;
      display: block;
    }

    #hamburger.active span:nth-child(1) {
      transform: rotate(45deg) translate(4px, 4px);
    }

    #hamburger.active span:nth-child(2) {
      opacity: 0;
      transform: translateX(-6px);
    }

    #hamburger.active span:nth-child(3) {
      transform: rotate(-45deg) translate(4px, -4px);
    }

    /* mobile nav panel (slides in from right) */
    .mobile-panel {
      position: fixed;
      top: 70px;
      /* below header */
      right: -100%;
      width: 260px;
      height: calc(100vh - 80px);
      background: linear-gradient(180deg, rgba(10, 12, 18, 0.98), rgba(8, 10, 14, 0.96));
      box-shadow: -20px 0 60px rgba(0, 0, 0, 0.6);
      z-index: 100;
      /* Increased z-index to ensure it sits above all page content (z-40) */
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      transition: right 0.36s cubic-bezier(.2, .9, .25, 1);
      border-left: 1px solid rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(8px);
    }

    .mobile-panel.open {
      right: 12px;
    }

    .mobile-panel a {
      color: #e6eef8;
      text-decoration: none;
      font-weight: 600;
    }

    .mobile-panel .close-btn {
      align-self: flex-end;
      background: transparent;
      border: 0;
      color: #bbb;
      cursor: pointer;
      padding: 6px;
    }

    /* small responsive fix for header elements */
    @media(min-width: 721px) {
      #hamburger {
        display: none;
      }

      .mobile-panel {
        display: none;
      }
    }
  </style>
</head>

<body>

  <canvas id="particles"></canvas>

  <header class="fixed top-4 left-4 right-4 z-50 flex items-center justify-between gap-4">
    <!-- LOGO -->
    <a href="#home" class="flex items-center gap-3">
      <div class="p-2 rounded-lg bg-white/5 backdrop-blur-md border border-white/10 flex items-center gap-3">

        <!-- Logo Icon Box -->
        <div class="w-10 h-10 rounded bg-gradient-to-br from-indigo-500 to-teal-400 
                flex items-center justify-center shadow-lg">
          <img src="image 1.jpg" class="w-10 h-10 rounded object-cover" />
            <path d="M5 12h14" stroke="#fff" stroke-width="1.5" stroke-linecap="round" />
          </svg>
        </div>

        <!-- Logo Text -->
        <div class="leading-tight">
          <div class="text-white font-semibold tracking-wide">DEMNET MRI</div>
          <div class="text-[11px] text-slate-300">Cognitive Memory Analysis</div>
        </div>
      </div>
    </a>


    <nav class="hidden md:flex items-center gap-3">
      <button class="px-3 py-2 rounded-md magnetic glass" data-target="home">Home</button>
      <button class="px-3 py-2 rounded-md magnetic glass" data-target="upload">Upload</button>
      <button class="px-3 py-2 rounded-md magnetic glass" data-target="model">Model</button>
      <button class="px-3 py-2 rounded-md magnetic glass" data-target="dashboard">Dashboard</button>
      <div class="ml-3 flex items-center gap-2">
        <button id="chatBtn" class="px-3 py-2 rounded glass magnetic">Chat</button>
      </div>
    </nav>

    <div id="hamburger" class="md:hidden" aria-label="Open menu" title="Menu">
      <span></span><span></span><span></span>
    </div>
  </header>


  <div id="mobilePanel" class="mobile-panel" aria-hidden="true">
    <button class="close-btn" id="mobileCloseBtn" aria-label="Close menu">✕</button>
    <a href="#" class="mobile-link" data-target="home">Home</a>
    <a href="#" class="mobile-link" data-target="upload">Upload</a>
    <a href="#" class="mobile-link" data-target="model">Model</a>
    <a href="#" class="mobile-link" data-target="dashboard">Dashboard</a>
    <div class="mt-auto">
      <button id="chatBtnMobile" class="w-full py-2 rounded glass">Chat</button>
    </div>
  </div>

  <main class="relative z-40 pt-28 pb-14 max-w-7xl mx-auto px-6">

    <section id="home" class="page glass neon p-6 rounded-2xl mb-8">
      <div class="grid md:grid-cols-2 gap-6 items-center">
        <div>
          <h1 class="text-4xl font-extrabold">Cognitive Memory Analysis — <span class="text-teal-300">DEMNET</span></h1>
          <p class="mt-3 text-slate-300 max-w-xl">MRI-based Alzheimer’s dementia classification with explainability
            (Grad-CAM), 3D visualizations and an interactive dashboard — ideal for a final-year demonstration or
            research prototype.</p>

          <div class="mt-6 flex gap-3">
            <button
              class="bg-gradient-to-r from-teal-400 to-indigo-500 px-5 py-3 rounded-lg text-black font-semibold magnetic"
              data-target="upload">Upload MRI</button>
            <button class="px-5 py-3 rounded-lg border border-white/10 glass magnetic" data-target="dashboard">View
              Dashboard</button>
          </div>

          <div class="mt-6 grid grid-cols-3 gap-3">
            <div class="p-4 glass rounded-lg">
              <div class="text-xs text-slate-300">Accuracy</div>
              <div class="text-2xl font-bold" id="countAcc">—</div>
            </div>
            <div class="p-4 glass rounded-lg">
              <div class="text-xs text-slate-300">AUC</div>
              <div class="text-2xl font-bold" id="countAuc">—</div>
            </div>
            <div class="p-4 glass rounded-lg">
              <div class="text-xs text-slate-300">F1</div>
              <div class="text-2xl font-bold" id="countF1">—</div>
            </div>
          </div>
        </div>

        <div class="relative">
          <div id="threeCube" class="w-full h-80 rounded-xl overflow-hidden"></div>
          <div class="absolute -bottom-8 left-6 glass rounded-lg p-3 shadow-lg flex items-center gap-3">
            <lottie-player src="https://assets6.lottiefiles.com/packages/lf20_1pxqjqps.json" background="transparent"
              speed="1" style="width:60px;height:60px;" loop autoplay></lottie-player>
            <div>
              <div class="text-sm text-slate-200">Interactive Brain</div>
              <div class="text-xs text-slate-400">Rotate • Zoom • Inspect</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- UPLOAD / MULTI-SLICE -->
    <section id="upload" class="page hidden glass neon p-6 rounded-2xl mb-8">
      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <h2 class="text-2xl font-bold">Upload MRI Series (multi-image)</h2>
          <p class="mt-2 text-slate-300">Select multiple slices (png/jpg). Use the slice player to animate the volume.
            For production, wire `/predict` to your backend.</p>

          <div class="mt-4">
            <input id="fileMulti" type="file" accept="image/*" multiple class="block w-full p-2 rounded-md glass" />
          </div>

          <div class="mt-4 grid grid-cols-2 gap-2">
            <button id="analyzeAll"
              class="px-4 py-2 rounded-md bg-gradient-to-r from-teal-400 to-indigo-500 text-black magnetic">Analyze
              Series</button>
            <button id="downloadReport" class="px-4 py-2 rounded-md border glass magnetic">Download PDF</button>
          </div>

          <div class="mt-4 glass p-3 rounded-lg">
            <div id="predSummary" class="hidden">
              <div class="text-sm text-slate-300">Prediction:</div>
              <div class="text-lg font-bold text-teal-300" id="predLabel">—</div>
              <div class="mt-2 text-xs text-slate-400" id="probList"></div>
              <div class="mt-3 flex gap-2">
                <button id="downloadPrediction" class="px-3 py-1 rounded glass magnetic">Download Image</button>
                <button id="showGrad" class="px-3 py-1 rounded glass magnetic">Show Grad-CAM</button>
              </div>
            </div>
          </div>
        </div>

        <div>
          <h3 class="text-lg font-semibold">Slice Player & Grad-CAM</h3>

          <div class="mt-3 relative bg-black/30 rounded-lg overflow-hidden flex items-center justify-center"
            style="height:360px;">
            <canvas id="sliceCanvas" style="max-width:100%; max-height:100%"></canvas>
            <canvas id="gradCanvas" class="gradcam-overlay hidden-el"></canvas>
          </div>

          <div class="mt-3 flex items-center gap-2">
            <button id="prevBtn" class="px-3 py-1 rounded glass magnetic">Prev</button>
            <input id="sliceSlider" type="range" min="0" max="0" value="0" class="flex-1" />
            <button id="nextBtn" class="px-3 py-1 rounded glass magnetic">Next</button>
          </div>

          <div class="mt-3 flex gap-2">
            <button id="playBtn" class="px-3 py-1 rounded bg-teal-400 text-black magnetic">Play</button>
            <button id="stopBtn" class="px-3 py-1 rounded glass magnetic">Stop</button>
          </div>
        </div>
      </div>
    </section>

    <!-- MODEL -->
    <section id="model" class="page hidden glass neon p-6 rounded-2xl mb-8">
      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <h2 class="text-2xl font-bold">DEMNET Architecture</h2>
          <p class="mt-2 text-slate-300">Repeated DEM blocks with Conv(3x3), BatchNorm, ReLU and MaxPool. Final global
            avg pool → dense → softmax (4 classes).</p>

          <div class="mt-4 flex gap-3">
            <div class="p-4 glass rounded-lg w-1/2">
              <div class="text-xs text-slate-300">Layers</div>
              <div class="text-lg font-semibold">Conv • Conv • Pool × N</div>
            </div>
            <div class="p-4 glass rounded-lg w-1/2">
              <div class="text-xs text-slate-300">Loss/Opt</div>
              <div class="text-lg font-semibold">Categorical CE • Adam</div>
            </div>
          </div>
        </div>

        <div>
          <h3 class="text-lg font-semibold">Animated CNN Diagram</h3>
          <div id="cnnDiagram" class="mt-4 flex gap-2 items-center"></div>
        </div>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="dashboard" class="page hidden glass neon p-6 rounded-2xl mb-8">
      <h2 class="text-2xl font-bold">Training Dashboard</h2>
      <div class="mt-4 grid md:grid-cols-3 gap-4">
        <div class="glass p-4 rounded-lg">
          <div class="text-xs text-slate-300">Train Loss</div>
          <canvas id="chartLoss"></canvas>
        </div>
        <div class="glass p-4 rounded-lg">
          <div class="text-xs text-slate-300">Val Accuracy</div>
          <canvas id="chartAcc"></canvas>
        </div>
        <div class="glass p-4 rounded-lg">
          <div class="text-xs text-slate-300">Class Distribution</div>
          <canvas id="chartDist"></canvas>
        </div>
      </div>

      <div class="mt-6 glass p-4 rounded-lg">
        <div class="text-xs text-slate-300">Confusion Matrix</div>
        <div id="confMatrix" class="mt-3 grid grid-cols-4 gap-2"></div>
      </div>
    </section>

  </main>

  <!-- CHATBOT (floating) -->
  <div id="chatbot"
    class="fixed right-6 bottom-6 w-80 bg-gradient-to-br from-slate-900 to-slate-800 glass p-3 rounded-xl shadow-lg hidden z-50">
    <div class="flex items-center justify-between">
      <div class="text-white font-semibold">DEMNET Assistant</div>
      <button id="closeChat" class="text-slate-300">✕</button>
    </div>
    <div id="chatBody" class="mt-3 max-h-48 overflow-y-auto text-sm space-y-2">
      <div class="text-slate-400">Ask me about dataset, model or explainability — this is a mock assistant.</div>
    </div>
    <div class="mt-3 flex gap-2">
      <input id="chatInput" class="flex-1 p-2 rounded bg-black/10 text-white text-sm"
        placeholder="Type a question..." />
      <button id="sendChat" class="px-3 py-2 rounded bg-teal-400 text-black">Send</button>
    </div>
  </div>

  <!-- TOASTS -->
  <div id="toast"></div>

  <!-- FOOTER -->
  <footer class="fixed left-6 bottom-6 text-slate-300 z-30">
    <div class="glass p-3 rounded-lg text-xs">
      © DEMNET • Project Demo — Team: MANISH RANJAN
    </div>
  </footer>

  <script>
    /* ---------------------------
        Helpers: toast
    --------------------------- */
    function toast(msg, ttl = 3000) {
      const t = document.createElement('div'); t.className = 'toast-item';
      t.innerText = msg; document.getElementById('toast').appendChild(t);
      setTimeout(() => t.remove(), ttl);
    }

    /* ---------------------------
        Particles background
    --------------------------- */
    const pCanvas = document.getElementById('particles');
    const pCtx = pCanvas.getContext('2d');
    function resizeParticles() { pCanvas.width = innerWidth; pCanvas.height = innerHeight; }
    resizeParticles(); window.addEventListener('resize', resizeParticles);
    const particles = Array.from({ length: 150 }).map(() => ({
      x: Math.random() * innerWidth, y: Math.random() * innerHeight,
      r: Math.random() * 2 + 0.5, vx: (Math.random() - 0.5) * 0.3, vy: (Math.random() - 0.5) * 0.3,
      hue: 180 + Math.random() * 120
    }));
    function drawParticles() {
      pCtx.clearRect(0, 0, pCanvas.width, pCanvas.height);
      particles.forEach(p => {
        p.x += p.vx; p.y += p.vy;
        if (p.x < -10) p.x = innerWidth + 10; if (p.x > innerWidth + 10) p.x = -10;
        if (p.y < -10) p.y = innerHeight + 10; if (p.y > innerHeight + 10) p.y = -10;
        const g = pCtx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.r * 8);
        g.addColorStop(0, `hsla(${p.hue},80%,60%,0.12)`); g.addColorStop(1, 'rgba(255,255,255,0)');
        pCtx.fillStyle = g; pCtx.beginPath(); pCtx.arc(p.x, p.y, p.r * 4, 0, Math.PI * 2); pCtx.fill();
      });
      requestAnimationFrame(drawParticles);
    }
    drawParticles();

    /* ---------------------------
        Page nav (desktop buttons and mobile links)
    --------------------------- */
    function showPage(id) {
      // Ensure all pages are hidden before showing the target page
      document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
      const el = document.getElementById(id);
      if (el) el.classList.remove('hidden');
      gsap.from("#" + id, { duration: 0.6, y: 20, opacity: 0, ease: "power3.out" });
    }
    document.querySelectorAll('[data-target]').forEach(btn => {
      btn.addEventListener('click', () => showPage(btn.dataset.target));
    });
    showPage('home');

    /* ---------------------------
        Magnetic hover
    --------------------------- */
    document.querySelectorAll('.magnetic').forEach(el => {
      el.addEventListener('mousemove', (e) => {
        const rect = el.getBoundingClientRect();
        const dx = (e.clientX - (rect.left + rect.width / 2)) / rect.width * 12;
        const dy = (e.clientY - (rect.top + rect.height / 2)) / rect.height * 12;
        el.style.transform = `translate(${dx}px, ${dy}px) scale(1.02)`;
      });
      el.addEventListener('mouseleave', () => el.style.transform = '');
    });

    /* ---------------------------
        Counters animation
    --------------------------- */
    function animateCount(id, to, duration = 1000) {
      const el = document.getElementById(id);
      let startTime = null;
      function step(ts) {
        if (!startTime) startTime = ts;
        const progress = Math.min((ts - startTime) / duration, 1);
        el.innerText = Math.round(progress * to);
        if (progress < 1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }
    setTimeout(() => { animateCount('countAcc', 92); animateCount('countAuc', 88); animateCount('countF1', 85); }, 800);

    /* ---------------------------
        Slice player (canvas)
    --------------------------- */
    let slices = [];
    const sliceCanvas = document.getElementById('sliceCanvas');
    const sCtx = sliceCanvas.getContext('2d');
    const gradCanvas = document.getElementById('gradCanvas');
    const gCtx = gradCanvas.getContext('2d');
    let currentIndex = 0, playTimer = null;

    function resizeCanvasToParent() {
      const box = sliceCanvas.parentElement.getBoundingClientRect();
      sliceCanvas.width = box.width; sliceCanvas.height = box.height;
      gradCanvas.width = box.width; gradCanvas.height = box.height;
    }
    resizeCanvasToParent();
    window.addEventListener('resize', resizeCanvasToParent);

    document.getElementById('fileMulti').addEventListener('change', async (e) => {
      const files = Array.from(e.target.files).slice(0, 40);
      if (files.length === 0) return toast('No files selected');
      toast('Loading slices...');
      slices = [];
      for (const f of files) {
        const img = new Image();
        img.src = URL.createObjectURL(f);
        await img.decode();
        slices.push(img);
      }
      document.getElementById('sliceSlider').max = Math.max(0, slices.length - 1);
      currentIndex = 0; drawSlice();
      toast('Slices loaded', 1200);
    });

    function drawSlice(index = currentIndex) {
      if (!slices.length) {
        sCtx.clearRect(0, 0, sliceCanvas.width, sliceCanvas.height);
        sCtx.fillStyle = 'rgba(255,255,255,0.02)'; sCtx.fillRect(0, 0, sliceCanvas.width, sliceCanvas.height);
        return;
      }
      const img = slices[index];
      const scale = Math.max(sliceCanvas.width / img.width, sliceCanvas.height / img.height);
      const w = img.width * scale, h = img.height * scale;
      const x = (sliceCanvas.width - w) / 2, y = (sliceCanvas.height - h) / 2;
      sCtx.clearRect(0, 0, sliceCanvas.width, sliceCanvas.height);
      sCtx.drawImage(img, x, y, w, h);

      // mock gradcam overlay
      gCtx.clearRect(0, 0, gradCanvas.width, gradCanvas.height);
      const t = Date.now() / 600;
      for (let i = 0; i < 4; i++) {
        const gx = gradCanvas.width * (0.2 + Math.abs(Math.sin(t + (i * 1.3))) * 0.6);
        const gy = gradCanvas.height * (0.2 + Math.abs(Math.cos(t + (i * 0.9))) * 0.6);
        const rad = Math.min(gradCanvas.width, gradCanvas.height) * (0.12 + 0.12 * Math.abs(Math.sin(t + i)));
        const g = gCtx.createRadialGradient(gx, gy, 0, gx, gy, rad);
        g.addColorStop(0, 'rgba(255,40,40,0.6)'); g.addColorStop(1, 'rgba(255,40,40,0)');
        gCtx.fillStyle = g; gCtx.beginPath(); gCtx.arc(gx, gy, rad, 0, Math.PI * 2); gCtx.fill();
      }
      gradCanvas.style.opacity = 0.5;
      gradCanvas.classList.remove('hidden-el');

      document.getElementById('sliceSlider').value = index;
      currentIndex = index;
    }

    document.getElementById('sliceSlider').addEventListener('input', (e) => drawSlice(+e.target.value));
    document.getElementById('prevBtn').addEventListener('click', () => drawSlice(Math.max(0, currentIndex - 1)));
    document.getElementById('nextBtn').addEventListener('click', () => drawSlice(Math.min(slices.length - 1, currentIndex + 1)));
    document.getElementById('playBtn').addEventListener('click', () => {
      if (playTimer) return; playTimer = setInterval(() => { drawSlice((currentIndex + 1) % slices.length); }, 220);
    });
    document.getElementById('stopBtn').addEventListener('click', () => { clearInterval(playTimer); playTimer = null; });

    /* ---------------------------
        Mock analyze & download
    --------------------------- */
    document.getElementById('analyzeAll').addEventListener('click', async () => {
      if (!slices.length) return toast('Load slices first');
      toast('Analyzing series (mock)...');
      await new Promise(r => setTimeout(r, 1200));
      const probs = [0.12, 0.56, 0.28, 0.04];
      document.getElementById('predLabel').innerText = 'Very Mild Demented (VMD)';
      document.getElementById('probList').innerText = `ND:${(probs[0] * 100).toFixed(1)}% • VMD:${(probs[1] * 100).toFixed(1)}% • MID:${(probs[2] * 100).toFixed(1)}% • MOD:${(probs[3] * 100).toFixed(1)}%`;
      document.getElementById('predSummary').classList.remove('hidden');
      toast('Analysis complete', 1600);
    });

    document.getElementById('downloadPrediction').addEventListener('click', async () => {
      if (!slices.length) return toast('No image to download');
      const blob = await new Promise(res => sliceCanvas.toBlob(res, 'image/png'));
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'prediction.png'; a.click(); URL.revokeObjectURL(url);
      toast('Downloaded prediction image');
    });

    /* ---------------------------
        PDF report using jsPDF
    --------------------------- */
    document.getElementById('downloadReport').addEventListener('click', async () => {
      if (!slices.length) return toast('No slices to report');
      toast('Generating PDF report...');
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'portrait', unit: 'px', format: [612, 792] });
      doc.setFontSize(16); doc.text('DEMNET — MRI Analysis Report', 40, 40);
      doc.setFontSize(12); doc.text(`Patient: Demo • Date: ${new Date().toLocaleString()}`, 40, 70);
      await html2canvas(sliceCanvas.parentElement, { background: '#0f172a' }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        doc.addImage(imgData, 'PNG', 40, 100, 520, 300);
      });
      doc.text('Prediction: ' + (document.getElementById('predLabel').innerText || '—'), 40, 420);
      doc.save('demnet_report.pdf');
      toast('PDF saved');
    });

    /* ---------------------------
        Charts (Chart.js)
    --------------------------- */
    (function mkCharts() {
      const loss = document.getElementById('chartLoss').getContext('2d');
      new Chart(loss, { type: 'line', data: { labels: ['E1', 'E2', 'E3', 'E4', 'E5', 'E6', 'E7', 'E8'], datasets: [{ label: 'Train Loss', data: [1.2, 0.95, 0.8, 0.6, 0.43, 0.32, 0.28, 0.24], borderColor: '#7c3aed', backgroundColor: 'rgba(124,58,237,0.12)', fill: true }] }, options: { plugins: { legend: { display: false } }, responsive: true } });

      const acc = document.getElementById('chartAcc').getContext('2d');
      new Chart(acc, { type: 'line', data: { labels: ['E1', 'E2', 'E3', 'E4', 'E5', 'E6', 'E7', 'E8'], datasets: [{ label: 'Val Accuracy', data: [0.62, 0.7, 0.76, 0.82, 0.86, 0.88, 0.9, 0.92], borderColor: '#06b6d4', backgroundColor: 'rgba(6,182,212,0.12)', fill: true }] }, options: { plugins: { legend: { display: false } } } });

      const dist = document.getElementById('chartDist').getContext('2d');
      new Chart(dist, { type: 'doughnut', data: { labels: ['ND', 'VMD', 'MID', 'MOD'], datasets: [{ data: [180, 80, 120, 40], backgroundColor: ['#60a5fa', '#7dd3fc', '#93c5fd', '#7c3aed'] }] }, options: { plugins: { legend: { position: 'bottom' } } } });

      // confusion matrix
      const cm = [[160, 12, 18, 10], [8, 60, 9, 3], [10, 14, 95, 1], [2, 1, 4, 33]];
      const cmDiv = document.getElementById('confMatrix'); cmDiv.innerHTML = '';
      cm.forEach(row => row.forEach(v => {
        const d = document.createElement('div'); d.className = 'glass p-3 rounded'; d.innerHTML = `<div class="text-sm text-slate-300"> ${v} </div>`; cmDiv.appendChild(d);
      }));
    })();

    /* ---------------------------
        Animated CNN diagram (simple)
    --------------------------- */
    (function cnnAnim() {
      const el = document.getElementById('cnnDiagram');
      for (let i = 0; i < 6; i++) {
        const block = document.createElement('div');
        block.className = 'p-3 rounded-lg glass flex flex-col items-center gap-1';
        block.style.width = (80 - i * 8) + 'px';
        block.innerHTML = `<div class="text-xs text-slate-300">Block ${i + 1}</div><div class="text-sm font-semibold">DEM</div>`;
        el.appendChild(block);
        gsap.from(block, { y: 20, opacity: 0, delay: i * 0.08, duration: 0.5, ease: 'power3.out' });
      }
    })();

    /* ---------------------------
        Chatbot mock
    --------------------------- */
    document.getElementById('chatBtn').addEventListener('click', () => document.getElementById('chatbot').classList.toggle('hidden'));
    document.getElementById('closeChat').addEventListener('click', () => document.getElementById('chatbot').classList.add('hidden'));
    document.getElementById('sendChat').addEventListener('click', sendChat);
    document.getElementById('chatInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChat(); });
    document.getElementById('chatBtnMobile')?.addEventListener('click', () => document.getElementById('chatbot').classList.toggle('hidden'));

    function sendChat() {
      const input = document.getElementById('chatInput'); const val = input.value.trim(); if (!val) return;
      const body = document.getElementById('chatBody');
      const user = document.createElement('div'); user.className = 'text-right text-xs text-teal-300'; user.innerText = 'You: ' + val; body.appendChild(user);
      input.value = ''; body.scrollTop = body.scrollHeight;
      setTimeout(() => {
        const bot = document.createElement('div'); bot.className = 'text-left text-sm text-slate-200';
        bot.innerText = `Assistant: This is a demo. For "${val}" you could: 1) check dataset stats 2) view Grad-CAM or 3) run training.`;
        body.appendChild(bot); body.scrollTop = body.scrollHeight;
      }, 700);
    }

    /* ---------------------------
        Mobile menu toggle (hamburger) - FIX 2: JS logic updated for overlay
    --------------------------- */
    const hamburger = document.getElementById('hamburger');
    const mobilePanel = document.getElementById('mobilePanel');
    const mobileCloseBtn = document.getElementById('mobileCloseBtn');
    const mobileOverlay = document.getElementById('mobileOverlay');

    hamburger.addEventListener('click', () => {
      hamburger.classList.toggle('active');
      mobilePanel.classList.toggle('open');

      const open = mobilePanel.classList.contains('open');
      mobilePanel.setAttribute('aria-hidden', !open);

      // FIX: Toggle the hidden class on the overlay
      if (open) {
        mobileOverlay.classList.remove('hidden');
        mobileOverlay.setAttribute('aria-hidden', 'false');
      } else {
        mobileOverlay.classList.add('hidden');
        mobileOverlay.setAttribute('aria-hidden', 'true');
      }
    });

    mobileCloseBtn.addEventListener('click', () => {
      hamburger.classList.remove('active');
      mobilePanel.classList.remove('open');
      mobilePanel.setAttribute('aria-hidden', 'true');

      // FIX: Hide the overlay when closing
      mobileOverlay.classList.add('hidden');
      mobileOverlay.setAttribute('aria-hidden', 'true');
    });

    // close when clicking mobile link and navigate
    document.querySelectorAll('.mobile-link').forEach(a => {
      a.addEventListener('click', (e) => {
        e.preventDefault();
        const target = a.dataset.target;
        hamburger.classList.remove('active');
        mobilePanel.classList.remove('open');
        mobilePanel.setAttribute('aria-hidden', 'true');

        // FIX: Hide the overlay on link click
        mobileOverlay.classList.add('hidden');
        mobileOverlay.setAttribute('aria-hidden', 'true');

        showPage(target);
      });
    });

    /* ---------------------------
        Keyboard: quick nav (1-home 2-upload 3-model 4-dash)
    --------------------------- */
    document.addEventListener('keydown', (e) => {
      if (e.key === '1') showPage('home'); if (e.key === '2') showPage('upload'); if (e.key === '3') showPage('model'); if (e.key === '4') showPage('dashboard');
    });

    /* ---------------------------
        Fetch metrics (optional)
    --------------------------- */
    (async function fetchMetrics() {
      try {
        const res = await fetch('/metrics'); if (!res.ok) throw 0;
        const d = await res.json();
        document.getElementById('countAcc').innerText = d.acc || '—';
        document.getElementById('countAuc').innerText = d.auc || '—';
        document.getElementById('countF1').innerText = d.f1 || '—';
      } catch (e) {
        // keep animated mock values
      }
    })();

    toast('Premium DEMNET frontend loaded — all features enabled', 4200);

    /* ---------------------------
        Three.js: Interactive 3D Brain + Neurons
        - Simple mouse/touch drag to rotate
        - Wheel to zoom
    --------------------------- */
    (function () {
      const container = document.getElementById('threeCube');
      if (!container) return;

      const W = container.clientWidth, H = container.clientHeight;
      const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(W, H); renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      renderer.setClearColor(0x000000, 0); // transparent
      container.appendChild(renderer.domElement);

      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(45, W / H, 0.1, 1000);
      camera.position.set(0, 0, 8);

      // lights
      scene.add(new THREE.AmbientLight(0xffffff, 0.25));
      const pLight = new THREE.PointLight(0x7c3aed, 1.25, 40);
      pLight.position.set(6, 6, 6);
      scene.add(pLight);

      // Brain (icosahedron + smooth displacement)
      const brainGeo = new THREE.IcosahedronGeometry(2.6, 3);
      // subtle vertex noise to look organic
      for (let i = 0; i < brainGeo.attributes.position.count; i++) {
        const v = new THREE.Vector3().fromBufferAttribute(brainGeo.attributes.position, i);
        const n = 1 + (Math.random() - 0.5) * 0.06;
        v.multiplyScalar(n);
        brainGeo.attributes.position.setXYZ(i, v.x, v.y, v.z);
      }
      brainGeo.computeVertexNormals();

      const brainMat = new THREE.MeshStandardMaterial({
        color: 0x7c3aed,
        transparent: true,
        opacity: 0.12,
        roughness: 0.6,
        metalness: 0.25,
        wireframe: true
      });
      const brain = new THREE.Mesh(brainGeo, brainMat);
      scene.add(brain);

      // neuron group
      const neuronsGroup = new THREE.Group();
      scene.add(neuronsGroup);

      const neuronCount = 140;
      const neuronGeo = new THREE.SphereGeometry(0.055, 8, 8);
      for (let i = 0; i < neuronCount; i++) {
        const phi = Math.acos(2 * Math.random() - 1);
        const theta = 2 * Math.PI * Math.random();
        const r = 2.1 + Math.random() * 0.35;
        const x = r * Math.sin(phi) * Math.cos(theta);
        const y = r * Math.sin(phi) * Math.sin(theta);
        const z = r * Math.cos(phi);
        const mat = new THREE.MeshStandardMaterial({
          emissive: 0x06b6d4,
          emissiveIntensity: 1,
          color: 0x052b2f,
          roughness: 0.2,
          metalness: 0.1
        });
        const m = new THREE.Mesh(neuronGeo, mat);
        m.position.set(x, y, z);
        // attach a random seed for pulsation
        m.userData.seed = Math.random() * 10;
        neuronsGroup.add(m);
      }

      // sparse connections
      const connections = new THREE.Group();
      scene.add(connections);
      const neuronMeshes = neuronsGroup.children;
      const lineMat = new THREE.LineBasicMaterial({ color: 0x7c3aed, transparent: true, opacity: 0.14, linewidth: 1 });
      for (let i = 0; i < neuronMeshes.length; i++) {
        for (let j = i + 1; j < neuronMeshes.length; j++) {
          if (Math.random() < 0.04) {
            const p1 = neuronMeshes[i].position;
            const p2 = neuronMeshes[j].position;
            const geom = new THREE.BufferGeometry().setFromPoints([p1, p2]);
            const line = new THREE.Line(geom, lineMat.clone());
            connections.add(line);
          }
        }
      }

      // simple user interaction: drag to rotate, wheel to zoom
      let isPointerDown = false, lastX = 0, lastY = 0;
      const targetRotation = { x: 0, y: 0 };
      const rotationVelocity = { x: 0, y: 0 };

      function onPointerDown(e) {
        isPointerDown = true;
        lastX = e.clientX || e.touches?.[0]?.clientX;
        lastY = e.clientY || e.touches?.[0]?.clientY;
      }
      function onPointerMove(e) {
        if (!isPointerDown) return;
        const cx = e.clientX || e.touches?.[0]?.clientX;
        const cy = e.clientY || e.touches?.[0]?.clientY;
        const dx = (cx - lastX) * 0.005;
        const dy = (cy - lastY) * 0.005;
        rotationVelocity.y = dx;
        rotationVelocity.x = dy;
        lastX = cx; lastY = cy;
      }
      function onPointerUp() { isPointerDown = false; }

      container.addEventListener('mousedown', onPointerDown);
      container.addEventListener('touchstart', onPointerDown, { passive: true });
      window.addEventListener('mousemove', onPointerMove);
      container.addEventListener('touchmove', onPointerMove, { passive: true });
      window.addEventListener('mouseup', onPointerUp);
      window.addEventListener('touchend', onPointerUp);

      // wheel zoom
      container.addEventListener('wheel', (e) => {
        e.preventDefault();
        camera.position.z += e.deltaY * 0.003;
        camera.position.z = Math.max(3, Math.min(18, camera.position.z));
      }, { passive: false });

      // animation loop
      function animate() {
        requestAnimationFrame(animate);

        // slowly damp velocity
        targetRotation.y += rotationVelocity.y;
        targetRotation.x += rotationVelocity.x;
        rotationVelocity.x *= 0.92;
        rotationVelocity.y *= 0.92;

        // apply rotation to groups
        const t = performance.now() * 0.001;
        brain.rotation.y += 0.002 + Math.sin(t * 0.3) * 0.0005;
        brain.rotation.x = targetRotation.x * 0.6;

        neuronsGroup.rotation.y = targetRotation.y * 0.7;
        neuronsGroup.rotation.x = targetRotation.x * 0.7;

        // pulsate neurons
        neuronsGroup.children.forEach((n, idx) => {
          const seed = n.userData.seed || 0;
          const pulse = 0.6 + Math.abs(Math.sin(t * 2 + seed)) * 0.9;
          n.scale.setScalar(0.6 + pulse * 0.12);
          // tweak emissive intensity
          n.material.emissiveIntensity = 0.6 + Math.abs(Math.sin(t * 2 + seed)) * 0.9;
        });

        renderer.render(scene, camera);
      }
      animate();

      // resize handling
      window.addEventListener('resize', () => {
        renderer.setSize(container.clientWidth, container.clientHeight);
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
      });
    })();
  </script>
</body>

</html>